<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Test Page</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
            background-color: #f4f4f4; 
            margin: 0; 
            padding: 20px; 
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.healthy {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.unhealthy {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .test-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ollama Connection Test</h1>
        
        <div class="section">
            <h2>Health Check</h2>
            <div id="health-status" class="status loading">Checking Ollama status...</div>
            <button onclick="checkHealth()">Refresh Health Check</button>
        </div>

        <div class="section">
            <h2>Available Models</h2>
            <div id="models-status" class="status loading">Loading models...</div>
            <button onclick="listModels()">Refresh Models</button>
        </div>

        <div class="section">
            <h2>Simple Test</h2>
            <input type="text" id="test-prompt" class="test-input" placeholder="Enter a test prompt..." value="Say hello in one sentence.">
            <button onclick="testSimple()">Test Simple Request</button>
            <div id="test-result" class="status" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>Wiki.js API Debug</h2>
            <div id="wiki-debug-status" class="status loading">Debugging Wiki.js API endpoints...</div>
            <button onclick="debugWikiAPI()">Debug API Endpoints</button>
            <div id="wiki-debug-result" class="status" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>Wiki.js Search Test</h2>
            <input type="text" id="search-input" class="test-input" placeholder="Enter search term..." value="SynapseTechLab">
            <button onclick="testWikiSearch()">Search Wiki.js</button>
            <div id="search-result" class="status" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>Wiki.js API Test</h2>
            <div id="wiki-api-status" class="status loading">Testing Wiki.js API...</div>
            <button onclick="testWikiAPI()">Test Wiki.js API</button>
            <div id="wiki-api-result" class="status" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>Wiki.js Pages</h2>
            <div id="wiki-pages-status" class="status loading">Loading Wiki.js pages...</div>
            <button onclick="listWikiPages()">Refresh Pages</button>
            <div id="wiki-pages-result" class="status" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>Wiki.js Connectivity Test</h2>
            <div id="wiki-status" class="status loading">Testing Wiki.js connectivity...</div>
            <button onclick="testWiki()">Test Wiki.js Connection</button>
            <div id="wiki-result" class="status" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>URL Fetch Test</h2>
            <input type="text" id="url-input" class="test-input" placeholder="Enter URL to test..." value="http://192.168.5.66:3000">
            <button onclick="testUrlFetch()">Test URL Fetch</button>
            <div id="url-result" class="status" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>Troubleshooting</h2>
            <h3>If Ollama is not working:</h3>
            <ol>
                <li><strong>Install Ollama:</strong> Download from <a href="https://ollama.ai/" target="_blank">https://ollama.ai/</a></li>
                <li><strong>Start Ollama:</strong> Run <code>ollama serve</code> in a terminal</li>
                <li><strong>Pull a model:</strong> Run <code>ollama pull llama3.1:latest</code> (or another model)</li>
                <li><strong>Check if running:</strong> Run <code>ollama list</code> to see available models</li>
            </ol>
            
            <h3>If Wiki.js connectivity fails:</h3>
            <ol>
                <li><strong>Check Wiki.js server:</strong> Ensure Wiki.js is running on the target machine</li>
                <li><strong>Verify IP address:</strong> Confirm the IP address is correct (192.168.5.66)</li>
                <li><strong>Check port:</strong> Verify port 3000 is open and accessible</li>
                <li><strong>Test manually:</strong> Try accessing http://192.168.5.66:3000 in your browser</li>
                <li><strong>Firewall settings:</strong> Check Windows Firewall on both machines</li>
                <li><strong>Network connectivity:</strong> Run <code>ping 192.168.5.66</code> to test basic connectivity</li>
            </ol>
            
            <h3>Common Issues:</h3>
            <ul>
                <li><strong>Port 11434 not accessible:</strong> Make sure Ollama is running and not blocked by firewall</li>
                <li><strong>Model not found:</strong> Pull the model first with <code>ollama pull [model-name]</code></li>
                <li><strong>Permission errors:</strong> Run as administrator or check file permissions</li>
                <li><strong>Network connectivity:</strong> Both machines must be on the same subnet and able to reach each other</li>
            </ul>
        </div>
    </div>

    <script>
        // Check health on page load
        window.onload = function() {
            checkHealth();
            listModels();
            testWiki();
            testWikiAPI();
            listWikiPages();
            debugWikiAPI();
        };

        async function checkHealth() {
            const statusDiv = document.getElementById('health-status');
            statusDiv.className = 'status loading';
            statusDiv.textContent = 'Checking Ollama status...';

            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    statusDiv.className = 'status healthy';
                    statusDiv.innerHTML = `
                        <strong>✅ Ollama is healthy!</strong><br>
                        Model: ${data.model}<br>
                        Status: ${data.status}
                    `;
                } else {
                    statusDiv.className = 'status unhealthy';
                    statusDiv.innerHTML = `
                        <strong>❌ Ollama is not healthy</strong><br>
                        Error: ${data.error}<br>
                        Status: ${data.status}
                    `;
                }
            } catch (error) {
                statusDiv.className = 'status unhealthy';
                statusDiv.innerHTML = `
                    <strong>❌ Cannot connect to Flask app</strong><br>
                    Error: ${error.message}
                `;
            }
        }

        async function listModels() {
            const statusDiv = document.getElementById('models-status');
            statusDiv.className = 'status loading';
            statusDiv.textContent = 'Loading models...';

            try {
                const response = await fetch('/models');
                const data = await response.json();
                
                if (data.status === 'success') {
                    statusDiv.className = 'status healthy';
                    statusDiv.innerHTML = `
                        <strong>✅ Models loaded successfully</strong><br>
                        <pre>${data.models}</pre>
                    `;
                } else {
                    statusDiv.className = 'status unhealthy';
                    statusDiv.innerHTML = `
                        <strong>❌ Failed to load models</strong><br>
                        Error: ${data.error}
                    `;
                }
            } catch (error) {
                statusDiv.className = 'status unhealthy';
                statusDiv.innerHTML = `
                    <strong>❌ Cannot connect to Flask app</strong><br>
                    Error: ${error.message}
                `;
            }
        }

        async function testWiki() {
            const statusDiv = document.getElementById('wiki-status');
            statusDiv.className = 'status loading';
            statusDiv.textContent = 'Testing Wiki.js connectivity...';

            try {
                const response = await fetch('/test-wiki');
                const data = await response.json();
                
                if (data.status === 'success') {
                    statusDiv.className = 'status healthy';
                    statusDiv.innerHTML = `
                        <strong>✅ Wiki.js connection successful!</strong><br>
                        Status Code: ${data.status_code}<br>
                        Content Length: ${data.content_length} characters<br>
                        <details>
                            <summary>Content Preview</summary>
                            <pre>${data.content_preview}</pre>
                        </details>
                    `;
                } else {
                    statusDiv.className = 'status unhealthy';
                    statusDiv.innerHTML = `
                        <strong>❌ Wiki.js connection failed</strong><br>
                        Error: ${data.message}<br>
                        ${data.error ? `Details: ${data.error}<br>` : ''}
                        ${data.suggestions ? `
                            <strong>Suggestions:</strong><br>
                            <ul>
                                ${data.suggestions.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        ` : ''}
                    `;
                }
            } catch (error) {
                statusDiv.className = 'status unhealthy';
                statusDiv.innerHTML = `
                    <strong>❌ Cannot test Wiki.js connection</strong><br>
                    Error: ${error.message}
                `;
            }
        }

        async function testUrlFetch() {
            const url = document.getElementById('url-input').value;
            const resultDiv = document.getElementById('url-result');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'status loading';
            resultDiv.textContent = 'Testing URL fetch...';

            try {
                const response = await fetch('/fetch-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url })
                });
                
                const data = await response.json();
                
                if (data.content && !data.content.startsWith('Error:')) {
                    resultDiv.className = 'status healthy';
                    resultDiv.innerHTML = `
                        <strong>✅ URL fetch successful!</strong><br>
                        Content Length: ${data.content.length} characters<br>
                        <details>
                            <summary>Content Preview</summary>
                            <pre>${data.content.substring(0, 1000)}${data.content.length > 1000 ? '...' : ''}</pre>
                        </details>
                    `;
                } else {
                    resultDiv.className = 'status unhealthy';
                    resultDiv.innerHTML = `
                        <strong>❌ URL fetch failed</strong><br>
                        Error: ${data.content || data.error}
                    `;
                }
            } catch (error) {
                resultDiv.className = 'status unhealthy';
                resultDiv.innerHTML = `
                    <strong>❌ URL fetch failed</strong><br>
                    Error: ${error.message}
                `;
            }
        }

        async function testSimple() {
            const prompt = document.getElementById('test-prompt').value;
            const resultDiv = document.getElementById('test-result');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'status loading';
            resultDiv.textContent = 'Testing...';

            try {
                const response = await fetch('/test-simple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: prompt })
                });
                
                const data = await response.json();
                
                if (data.response && !data.response.startsWith('Error:')) {
                    resultDiv.className = 'status healthy';
                    resultDiv.innerHTML = `
                        <strong>✅ Test successful!</strong><br>
                        Response: ${data.response}
                    `;
                } else {
                    resultDiv.className = 'status unhealthy';
                    resultDiv.innerHTML = `
                        <strong>❌ Test failed</strong><br>
                        Error: ${data.response}
                    `;
                }
            } catch (error) {
                resultDiv.className = 'status unhealthy';
                resultDiv.innerHTML = `
                    <strong>❌ Test failed</strong><br>
                    Error: ${error.message}
                `;
            }
        }

        async function testWikiAPI() {
            const statusDiv = document.getElementById('wiki-api-status');
            statusDiv.className = 'status loading';
            statusDiv.textContent = 'Testing Wiki.js API...';

            try {
                const response = await fetch('/test-wiki-api');
                const data = await response.json();
                
                if (data.status === 'success') {
                    statusDiv.className = 'status healthy';
                    statusDiv.innerHTML = `
                        <strong>✅ Wiki.js API connection successful!</strong><br>
                        ${data.message}<br>
                        ${data.total_pages ? `Total Pages: ${data.total_pages}<br>` : ''}
                        ${data.pages ? `
                            <details>
                                <summary>Available Pages</summary>
                                <ul>
                                    ${data.pages.map(page => `<li><strong>${page.title}</strong> (${page.path})<br><em>${page.description}</em></li>`).join('')}
                                </ul>
                            </details>
                        ` : ''}
                    `;
                } else {
                    statusDiv.className = 'status unhealthy';
                    statusDiv.innerHTML = `
                        <strong>❌ Wiki.js API connection failed</strong><br>
                        Error: ${data.message}<br>
                        ${data.error ? `Details: ${data.error}<br>` : ''}
                        ${data.suggestions ? `
                            <strong>Suggestions:</strong><br>
                            <ul>
                                ${data.suggestions.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        ` : ''}
                    `;
                }
            } catch (error) {
                statusDiv.className = 'status unhealthy';
                statusDiv.innerHTML = `
                    <strong>❌ Cannot test Wiki.js API</strong><br>
                    Error: ${error.message}
                `;
            }
        }

        async function listWikiPages() {
            const statusDiv = document.getElementById('wiki-pages-status');
            statusDiv.className = 'status loading';
            statusDiv.textContent = 'Loading Wiki.js pages...';

            try {
                const response = await fetch('/wiki-pages');
                const data = await response.json();
                
                if (data.status === 'success') {
                    statusDiv.className = 'status healthy';
                    statusDiv.innerHTML = `
                        <strong>✅ Wiki.js pages loaded successfully!</strong><br>
                        Total Pages: ${data.pages.length}<br>
                        <details>
                            <summary>All Pages</summary>
                            <ul>
                                ${data.pages.map(page => `<li><strong>${page.title || 'Untitled'}</strong> (${page.path || 'No path'})<br><em>${page.description || 'No description'}</em></li>`).join('')}
                            </ul>
                        </details>
                    `;
                } else {
                    statusDiv.className = 'status unhealthy';
                    statusDiv.innerHTML = `
                        <strong>❌ Failed to load Wiki.js pages</strong><br>
                        Error: ${data.message}
                    `;
                }
            } catch (error) {
                statusDiv.className = 'status unhealthy';
                statusDiv.innerHTML = `
                    <strong>❌ Cannot load Wiki.js pages</strong><br>
                    Error: ${error.message}
                `;
            }
        }

        async function testWikiSearch() {
            const searchTerm = document.getElementById('search-input').value;
            const resultDiv = document.getElementById('search-result');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'status loading';
            resultDiv.textContent = 'Searching Wiki.js...';

            try {
                const response = await fetch('/search-wiki', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ search_term: searchTerm })
                });
                
                const data = await response.json();
                
                if (data.content && !data.content.startsWith('Error:')) {
                    resultDiv.className = 'status healthy';
                    resultDiv.innerHTML = `
                        <strong>✅ Wiki.js search successful!</strong><br>
                        Search Term: "${searchTerm}"<br>
                        <details>
                            <summary>Search Results</summary>
                            <pre>${data.content}</pre>
                        </details>
                    `;
                } else {
                    resultDiv.className = 'status unhealthy';
                    resultDiv.innerHTML = `
                        <strong>❌ Wiki.js search failed</strong><br>
                        Error: ${data.content || data.error}
                    `;
                }
            } catch (error) {
                resultDiv.className = 'status unhealthy';
                resultDiv.innerHTML = `
                    <strong>❌ Wiki.js search failed</strong><br>
                    Error: ${error.message}
                `;
            }
        }

        async function debugWikiAPI() {
            const statusDiv = document.getElementById('wiki-debug-status');
            const resultDiv = document.getElementById('wiki-debug-result');
            
            statusDiv.className = 'status loading';
            statusDiv.textContent = 'Debugging Wiki.js API endpoints...';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch('/debug-wiki-api');
                const data = await response.json();
                
                if (data.status === 'success') {
                    statusDiv.className = 'status healthy';
                    statusDiv.textContent = 'Debug completed successfully!';
                    
                    let resultsHtml = '<strong>API Endpoint Test Results:</strong><br><br>';
                    
                    data.results.forEach(result => {
                        const statusIcon = result.success ? '✅' : '❌';
                        const statusClass = result.success ? 'healthy' : 'unhealthy';
                        
                        resultsHtml += `
                            <div class="status ${statusClass}" style="margin: 10px 0; padding: 10px;">
                                <strong>${statusIcon} ${result.endpoint}</strong><br>
                                Status Code: ${result.status_code}<br>
                                Content Type: ${result.content_type}<br>
                                Content Length: ${result.content_length}<br>
                                ${result.data_type ? `Data Type: ${result.data_type}<br>` : ''}
                                ${result.data_preview ? `Data Preview: <pre style="font-size: 12px; margin: 5px 0;">${result.data_preview}</pre>` : ''}
                                ${result.error ? `Error: <pre style="font-size: 12px; margin: 5px 0;">${result.error}</pre>` : ''}
                            </div>
                        `;
                    });
                    
                    resultDiv.innerHTML = resultsHtml;
                } else {
                    statusDiv.className = 'status unhealthy';
                    statusDiv.textContent = 'Debug failed!';
                    resultDiv.innerHTML = `<strong>❌ Debug failed</strong><br>Error: ${data.message}`;
                }
            } catch (error) {
                statusDiv.className = 'status unhealthy';
                statusDiv.textContent = 'Debug failed!';
                resultDiv.innerHTML = `<strong>❌ Debug failed</strong><br>Error: ${error.message}`;
            }
        }
    </script>
</body>
</html> 
